name: Test Action
on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # - name: Copy files via SCP
    #   run: |
    #     mkdir -p ~/.ssh
    #     echo "${{ secrets.SINGAPORE_VPC_UBUNTU_EC2_SSH_PRIVATE_KEY }}" > key.pem
    #     cat key.pem
    #     chmod 700 ./key.pem
    #     ssh-keyscan -p 40382 162.191.2.78 >> ~/.ssh/known_hosts
    #     cat >> ~/.ssh/config <<END
    #     Host 162.191.2.78
    #       port 40382
    #       IdentityFile ./key.pem
    #       User user
    #       IdentitiesOnly yes
    #       StrictHostKeyChecking no
    #       ForwardAgent yes
    #     END
    #     eval $(ssh-agent -s)
    #     ssh-add ./key.pem
    #     ssh-add -L
    #     echo "after key scan"
    #     echo "new file to test" >> new.txt
    #     ls -la
    #     ssh -p 40382 user@162.191.2.78 "del "C:\\Users\\User\\Desktop\\text.txt""

    - name: Setup SSH
      run: |
          mkdir -p ~/.ssh
          # Add the SSH private key from the secret
          echo "${{ secrets.SINGAPORE_VPC_UBUNTU_EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Configure SSH settings
          echo "Host 162.191.2.78" > ~/.ssh/config
          echo "  HostName 162.191.2.78" >> ~/.ssh/config          # Replace with actual IP/hostname
          echo "  User user" >> ~/.ssh/config                    # Replace with actual username
          echo "  Port 40382" >> ~/.ssh/config                      # Replace with actual SSH port
          echo "  IdentityFile ~/.ssh/id_rsa" >> ~/.ssh/config
          echo "  StrictHostKeyChecking no" >> ~/.ssh/config

    - name: Test SSH Connection
      run: ssh -p 40382 user@162.191.2.78 "echo 'Connected successfully!'"
