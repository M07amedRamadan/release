name: Destroy CloudFormation Stack

on:
  # push:
  #   branches:
  #    - main
  workflow_dispatch:
   inputs:
      Stack_Name:
        description: 'AWS CloudFormation stack name'
        required: true

jobs:
  destroy-stack:
    runs-on: ubuntu-latest

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1 # Replace with your AWS region

      - name: Delete CloudFormation Stack
        run: |
            aws cloudformation get-template --stack-name ${{ github.event.inputs.Stack_Name }} --deletion-mode FORCE_DELETE_STACK --query TemplateBody --output text > current-template.yaml
            chmod +w current-template.yaml
            ls -la
            sed -i'' -e 's/Retain/Delete/g' current-template.yaml            
            cat current-template.yaml
            echo "validating... "
            aws cloudformation validate-template --template-body file://current-template.yaml
            echo "validation done... "
            echo "update Stack"
            echo "delete Stack"
            aws cloudformation delete-stack --stack-name ${{ github.event.inputs.Stack_Name }} 
            echo "wait delete Stack"
            aws cloudformation wait stack-delete-complete --stack-name ${{ github.event.inputs.Stack_Name }}
            
            
        #echo "after update"             aws cloudformation update-stack --stack-name ${{ github.event.inputs.Stack_Name }} --template-body file://current-template.yaml --capabilities CAPABILITY_IAM

        #aws cloudformation get-template --stack-name ${{ github.event.inputs.Stack_Name }}

